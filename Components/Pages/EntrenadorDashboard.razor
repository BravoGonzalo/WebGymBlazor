@page "/dashboard-entrenador/{dni}"
@rendermode InteractiveServer
@inject ProyectoGym.Business.EntrenadorService EntrenadorService
@inject ProyectoGym.Business.ClienteService ClienteService
@inject ProyectoGym.Business.PagoService PagoService
@inject NavigationManager Navigation
@using ProyectoGym.Domain

<div class="container-fluid mt-4">

    @if (entrenador == null)
    {
        <div class="alert alert-warning text-center">Entrenador no encontrado.</div>
    }
    else
    {
        <div class="mb-4 p-3 bg-light rounded shadow-sm">
            <h5>Entrenador: @entrenador.nombre @entrenador.apellido</h5>
            <div class="d-flex">
                <small class="me-3"><strong>DNI:</strong> @entrenador.dni</small>
                <small><strong>Email:</strong> @entrenador.email</small>
            </div>
        </div>

        <div class="d-flex justify-content-end mb-3">
            <button class="btn btn-primary" @onclick="IrAGestionEntrenadores">
                <i class="bi bi-person-badge-fill"></i> Gestionar Entrenadores
            </button>
        </div>

        <div class="card shadow-sm">
            <div class="card-header d-flex justify-content-between align-items-center">
                <h4 class="mb-0">Mis Clientes</h4>
                <button class="btn btn-success" @onclick="AgregarCliente">
                    <i class="bi bi-person-plus-fill"></i> + Agregar Cliente
                </button>
            </div>
            <div class="card-body">
                @if (!clientes.Any())
                {
                    <p class="text-center">No tienes clientes registrados.</p>
                }
                else
                {
                    <div class="table-responsive">
                        <table class="table table-bordered table-striped table-hover">
                            <thead class="table-dark">
                                <tr>
                                    <th>Nombre</th>
                                    <th>Apellido</th>
                                    <th>DNI</th>
                                    <th>Email</th>
                                    <th>Pago</th>
                                    <th>Acciones</th>
                                </tr>
                            </thead>
                            <tbody>
                                @foreach (var cliente in clientes)
                                {
                                    <tr>
                                        <td>@cliente.nombre</td>
                                        <td>@cliente.apellido</td>
                                        <td>@cliente.dni</td>
                                        <td>@cliente.email</td>

                                        <td>
                                            @if (cliente.EstaAlDia)
                                            {
                                                <span class="badge bg-success">Al día</span>
                                            }
                                            else
                                            {
                                                <span class="badge bg-danger">Pendiente</span>
                                            }
                                        </td>

                                        <td>
                                            <button class="btn btn-success btn-sm me-1" @onclick="() => RegistrarPago(cliente.Id)" title="Registrar Pago">
                                                Pagar
                                            </button>
                                            <button class="btn btn-info btn-sm me-1" @onclick="() => VerHistorialPagos(cliente.Id)" title="Ver Historial de Pagos">
                                                Historial
                                            </button>
                                            <button class="btn btn-primary btn-sm me-1" @onclick="() => AsignarRutina(cliente.Id)" title="Asignar Rutina">
                                                Rutina
                                            </button>
                                            <button class="btn btn-warning btn-sm me-1" @onclick="() => EditarCliente(cliente.Id)" title="Editar Cliente">
                                                Editar
                                            </button>
                                            <button class="btn btn-danger btn-sm" @onclick="() => EliminarCliente(cliente.Id)" title="Eliminar Cliente">
                                                Eliminar
                                            </button>
                                        </td>
                                    </tr>
                                }
                            </tbody>
                        </table>
                    </div>
                }
            </div>
        </div>

    }
</div>

@code {
    [Parameter] public string dni { get; set; } = string.Empty;
    private Entrenador? entrenador;
    private List<Cliente> clientes = new();

    protected override void OnParametersSet()
    {
        RecargarClientes();
    }

    private void RecargarClientes()
    {
        entrenador = EntrenadorService.GetByDni(dni);
        if (entrenador != null)
        {
            clientes = ClienteService.GetByEntrenadorId(entrenador.Id);
        }
        else
        {
            Console.WriteLine($" No se encontró entrenador con DNI: {dni}");
        }
    }

    private void AgregarCliente()
    {
        Navigation.NavigateTo($"/agregar-cliente/{dni}");
    }

    private void EditarCliente(int clienteId)
    {
        Navigation.NavigateTo($"/editar-cliente/{clienteId}/{entrenador?.dni}");
    }

    private void AsignarRutina(int clienteId)
    {
        Navigation.NavigateTo($"/asignar-rutina/{clienteId}/{entrenador?.dni}");
    }

    private void VerHistorialPagos(int clienteId)
    {
        Navigation.NavigateTo($"/historial-pagos/{clienteId}/{entrenador?.dni}");
    }

    private void IrAGestionEntrenadores()
    {
        Navigation.NavigateTo($"/gestion-entrenadores/{dni}");
    }

    private void RegistrarPago(int clienteId)
    {
        try
        {
            var nuevoPago = new Pago
            {
                ClienteId = clienteId,
                FechaDePago = DateTime.Now,
                Monto = 5000
            };

            PagoService.CrearPago(nuevoPago);
            RecargarClientes();
            StateHasChanged();
        }
        catch (Exception ex)
        {
            Console.WriteLine($"Error al registrar pago: {ex.Message}");
        }
    }

    private void EliminarCliente(int clienteId)
    {
        try
        {
            ClienteService.EliminarCliente(clienteId);
            var clienteParaBorrar = clientes.FirstOrDefault(c => c.Id == clienteId);
            if (clienteParaBorrar != null)
            {
                clientes.Remove(clienteParaBorrar);
                StateHasChanged();
            }
        }
        catch (Exception ex)
        {
            Console.WriteLine($"Error al eliminar cliente: {ex.Message}");
        }
    }

}